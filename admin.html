<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Panel RCP</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: linear-gradient(to right, #eef2f3, #f6f8fa);
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #1e3c72;
    }
    label {
      font-weight: 500;
      margin-right: 10px;
    }
    select {
      margin-left: 6px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: #fff;
      transition: border-color 0.3s;
    }
    select:hover {
      border-color: #1e90ff;
    }
    button {
      padding: 6px 10px;
      margin: 2px;
      background-color: #1e90ff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #167ac6;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }
    th {
      background-color: #f1f4f9;
      padding: 10px;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
    }
    td {
      padding: 10px;
      font-size: 14px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
    }
    td[contenteditable] {
      background-color: #fcfcfc;
      border: 1px dashed transparent;
    }
    td[contenteditable]:hover {
      background-color: #f2f9ff;
      border-color: #cce4ff;
    }
    td[contenteditable]:focus {
      outline: none;
      border: 1px solid #1e90ff;
      background-color: #eaf4ff;
    }
    tfoot td {
      font-weight: bold;
      background-color: #f1f4f9;
    }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        font-size: 13px;
      }
      select, button {
        margin-top: 10px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

<h1>Panel RCP</h1>

<label>Pracownik:
  <select id="filterUser"><option value="">Wszyscy</option></select>
</label>

<label>Miesiąc:
  <select id="filterMonth"><option value="">Wszystkie</option></select>
</label>

<button id="exportBtn">Eksportuj</button>

<table id="tabela-pracownikow">
  <thead>
    <tr>
      <th>Login</th>
      <th>Data</th>
      <th>Start</th>
      <th>Koniec</th>
      <th>Godziny</th>
      <th>Akcje / Status</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBctpY5tMVCISGsUsw_PwNUSQPnUlW2nPc",
    authDomain: "rejestracja-czasu-pracy-e345e.firebaseapp.com",
    projectId: "rejestracja-czasu-pracy-e345e",
    storageBucket: "rejestracja-czasu-pracy-e345e.appspot.com",
    messagingSenderId: "198373663295",
    appId: "1:198373663295:web:a2a07384d8814101254e8a",
    measurementId: "G-6CG743TGTS"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      alert("Musisz być zalogowany, aby korzystać z panelu administratora.");
      window.location.href = "login.html";
    } else {
      wczytaj();
    }
  });

  const tabelaBody  = document.querySelector("#tabela-pracownikow tbody");
  const tabelaFoot  = document.querySelector("#tabela-pracownikow tfoot");
  const filterUser  = document.getElementById("filterUser");
  const filterMonth = document.getElementById("filterMonth");
  const exportBtn   = document.getElementById("exportBtn");
  let aktualneDane  = [];

  function obliczGodziny(start, end) {
    if (!/^\d{2}:\d{2}$/.test(start) || !/^\d{2}:\d{2}$/.test(end)) return "0.00";
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    const godziny = ((eh * 60 + em) - (sh * 60 + sm)) / 60;
    return godziny > 0 ? godziny.toFixed(2) : "0.00";
  }

  async function wczytaj() {
    try {
      const user = firebase.auth().currentUser;
      const token = await user.getIdTokenResult();
      const rola = token.claims?.rola || "brak";

      const snapshot = await db.collection("godziny").get();
      const wszystkieDane = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          login: data.login || "",
          data: data.data || "",
          start: data.start || "",
          end: data.end || "",
          godziny: data.godziny || obliczGodziny(data.start, data.end),
          statusNadgodzin: data.statusNadgodzin || "oczekujące"
        };
      });

      const unikalni = [...new Set(wszystkieDane.map(d => d.login))];
      if (filterUser.options.length <= 1) {
        filterUser.innerHTML = '<option value="">Wszyscy</option>' +
          unikalni.map(u => `<option value="${u}">${u}</option>`).join('');
      }

      const miesiace = [...new Set(wszystkieDane.map(d => d.data?.slice(0, 7)).filter(Boolean))];
      if (filterMonth.options.length <= 1) {
        filterMonth.innerHTML = '<option value="">Wszystkie</option>' +
          miesiace.map(m => `<option value="${m}">${m}</option>`).join('');
      }

      aktualneDane = wszystkieDane.filter(d =>
        (!filterUser.value || d.login === filterUser.value) &&
        (!filterMonth.value || (d.data && d.data.startsWith(filterMonth.value)))
      );
      aktualneDane.sort((a, b) => new Date(b.data) - new Date(a.data));

      tabelaBody.innerHTML = "";
      aktualneDane.forEach(dane => {
        const tr = document.createElement("tr");

        const akcjeHTML = `
          <button onclick="usunRekord('${dane.id}')">Usuń</button>
          ${rola === "admin" ? `
            <button onclick="zmienStatus('${dane.id}', 'zaakceptowane')">Akceptuj</button>
            <button onclick="zmienStatus('${dane.id}', 'odrzucone')">Odrzuć</button>
          ` : ""}
        `;

        tr.innerHTML = `
          <td>${dane.login}</td>
          <td>${dane.data}</td>
          <td contenteditable onblur="zapiszZmiane('${dane.id}','start',this.innerText)">${dane.start}</td>
          <td contenteditable onblur="zapiszZmiane('${dane.id}','end',this.innerText)">${dane.end}</td>
          <td class="godziny">${dane.godziny}</td>
          <td>${akcjeHTML}<br>Status: <strong>${dane.statusNadgodzin}</strong></td>
        `;
        tabelaBody.appendChild(tr);
      });

      rysujStopke(aktualneDane);
    } catch (err) {
      console.error("Błąd pobierania danych:", err);
      alert("Nie udało się pobrać danych.");
    }
  }

  function rysujStopke(rows) {
    const suma = rows.reduce((acc, r) => acc + parseFloat(r.godziny || 0), 0).toFixed(2);
    tabelaFoot.innerHTML = `
      <tr>
        <td colspan="4"><strong>Razem</strong></td>
        <td><strong>${suma}</strong></td>
        <td></td>
      </tr>`;
  }

  async function zapiszZmiane(id, pole, wartosc) {
    if ((pole === "start" || pole === "end") && !/^\d{2}:\d{2}$/.test(wartosc)) {
      alert("Nieprawidłowy format godziny. Użyj HH:MM");
      wczytaj();
      return;
    }
    const docRef = db.collection("godziny").doc(id);
    const docSnap = await docRef.get();
    if (!docSnap.exists) return;
    const dane = docSnap.data();
    dane[pole] = wartosc;
    if (dane.start && dane.end) {
      dane.godziny = obliczGodziny(dane.start, dane.end);
    }
    await docRef.set(dane);
    wczytaj();
  }

  async function usunRekord(id) {
    if (confirm("Czy na pewno chcesz usunąć ten wpis?")) {
      await db.collection("godziny").doc(id).delete();
      wczytaj();
    }
  }

  async function zmienStatus(id, nowyStatus) {
    try {
      await db.collection("godziny").doc(id).update({ statusNadgodzin: nowyStatus });
      wczytaj();
    } catch (e) {
      alert("Błąd zmiany statusu");
      console.error(e);
    }
  }

  exportBtn.addEventListener("click", () => {
    const wb = XLSX.utils.book_new();

    const danePosortowane = [...aktualneDane].sort((a, b) => {
      if (a.login === b.login) {
        return new Date(a.data) - new Date(b.data);
      }
      return a.login.localeCompare(b.login);
    });

    const daneDoEksportu = danePosortowane.map(row => ({
      Login: row.login,
      Data: row.data,
      Start: row.start,
      Koniec: row.end,
      Godziny: row.godziny,
      Status: row.statusNadgodzin
    }));

    const ws1 = XLSX.utils.json_to_sheet(daneDoEksportu, {
      header: ["Login", "Data", "Start", "Koniec", "Godziny", "Status"]
    });
    XLSX.utils.book_append_sheet(wb, ws1, "Godziny");

    XLSX.writeFile(wb, "raport_miesieczny.xlsx");
  });

  filterUser.addEventListener("change", wczytaj);
  filterMonth.addEventListener("change", wczytaj);
  window.zapiszZmiane = zapiszZmiane;
  window.usunRekord = usunRekord;
  window.zmienStatus = zmienStatus;
</script>

</body>
</html>
