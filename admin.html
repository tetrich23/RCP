<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Panel Administratora</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    /* global */
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: linear-gradient(to right, #e9eff5, #fdfdfd);
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    h2 {
      margin-top: 40px;
      margin-bottom: 10px;
      font-size: 20px;
      color: #2c3e50;
    }

    /* tables */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background-color: white;
    }
    thead th {
      background-color: #f5f7fa;
      padding: 12px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 13px;
      text-align: left;
    }
    tbody td, tfoot td {
      padding: 10px;
      border-top: 1px solid #e0e6ed;
      font-size: 14px;
      text-align: left;
    }
    tfoot td {
      background-color: #f5f7fa;
    }

    /* buttons */
    .danger {
      background-color: #c0392b;
      color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .danger:hover {
      background-color: #922b21;
    }
  </style>
</head>
<body>
  <h1>Panel Administratora</h1>

  <h2>Użytkownicy</h2>
  <table>
    <thead>
      <tr>
        <th>Email</th>
        <th>Rola</th>
        <th>Akcja</th>
      </tr>
    </thead>
    <tbody id="listaUzytkownikow">
      <!-- wczytywane przez JS -->
    </tbody>
  </table>

  <h2>Rejestr wejść/wyjść</h2>
  <table>
    <thead>
      <tr>
        <th>Pracownik</th>
        <th>Data</th>
        <th>Start</th>
        <th>Koniec</th>
        <th>Godziny</th>
      </tr>
    </thead>
    <tbody id="tabelaGodzin">
      <!-- wczytywane przez JS -->
    </tbody>
    <tfoot>
      <tr>
        <td colspan="4" style="font-weight: bold; text-align: right;">Razem</td>
        <td id="sumaGodzin" style="font-weight: bold;"></td>
      </tr>
    </tfoot>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBctpY5tMVCISGsUsw_PwNUSQPnUlW2nPc",
      authDomain: "rejestracja-czasu-pracy-e345e.firebaseapp.com",
      projectId: "rejestracja-czasu-pracy-e345e",
      storageBucket: "rejestracja-czasu-pracy-e345e.appspot.com",
      messagingSenderId: "198373663295",
      appId: "1:198373663295:web:a2a07384d8814101254e8a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function obliczCzas(start, koniec) {
      if (!start || !koniec) return { h: 0, m: 0 };
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = koniec.split(":").map(Number);
      let startMin = sh * 60 + sm, endMin = eh * 60 + em;
      if (endMin < startMin) endMin += 24 * 60;
      const diff = endMin - startMin;
      return { h: Math.floor(diff / 60), m: diff % 60 };
    }

    function formatCzas(h, m) {
      return `${h}h ${m}min`;
    }

    async function wczytajUzytkownikow() {
      const tbody = document.getElementById("listaUzytkownikow");
      tbody.innerHTML = "";
      const snap = await db.collection("users").get();
      snap.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${doc.id}</td>
          <td>${data.rola || "—"}</td>
          <td><button class="danger" onclick="usunUzytkownika('${doc.id}')">Usuń</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function wczytajGodziny() {
      const tbody = document.getElementById("tabelaGodzin");
      const sumaTd = document.getElementById("sumaGodzin");
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px">Ładowanie...</td></tr>`;
      sumaTd.innerText = "";
      const rolaMap = {};
      (await db.collection("users").get())
        .forEach(d => rolaMap[d.id] = d.data().rola || "—");

      const godzSnap = await db.collection("godziny")
        .orderBy("data","desc").limit(200).get();
      tbody.innerHTML = "";
      let totalMin = 0;

      godzSnap.forEach(doc => {
        const d = doc.data(), email = d.email || "—";
        if (!["pracownik","kierownik","dyrektor"].includes(rolaMap[email])) return;
        const czas = obliczCzas(d.wejscie||"", d.wyjscie||"");
        totalMin += czas.h*60 + czas.m;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${email}</td>
          <td>${d.data || "—"}</td>
          <td>${d.wejscie || ""}</td>
          <td>${d.wyjscie || ""}</td>
          <td>${formatCzas(czas.h, czas.m)}</td>
        `;
        tbody.appendChild(tr);
      });

      const h = Math.floor(totalMin/60), m = totalMin%60;
      sumaTd.innerText = formatCzas(h, m);
    }

    async function usunUzytkownika(email) {
      if (!confirm(`Czy na pewno usunąć: ${email}?`)) return;
      await db.collection("users").doc(email).delete();
      wczytajUzytkownikow();
      wczytajGodziny();
    }

    firebase.auth().onAuthStateChanged(u => {
      if (!u) return location.href="index.html";
      wczytajUzytkownikow();
      wczytajGodziny();
    });
  </script>
</body>
</html>
