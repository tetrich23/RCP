<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Panel Kadry</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f6f8fa; }
    h1 { text-align: center; }
    label { margin-right: 10px; }
    select, button { padding: 6px 10px; margin-right: 10px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    td[contenteditable] { background-color: #f9f9f9; }
    tfoot td { font-weight: bold; }
  </style>
</head>
<body>
<h1>Panel RCP</h1>

<label>Pracownik:
  <select id="filterUser"><option value="">Wszyscy</option></select>
</label>

<label>Miesiąc:
  <select id="filterMonth"><option value="">Wszystkie</option></select>
</label>

<button id="exportBtn">Eksportuj</button>

<table id="tabela-pracownikow">
  <thead>
    <tr>
      <th>Pracownik</th>
      <th>Data</th>
      <th>Start</th>
      <th>Koniec</th>
      <th>Godziny</th>
      <th>Akcje</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBctpY5tMVCISGsUsw_PwNUSQPnUlW2nPc",
  authDomain: "rejestracja-czasu-pracy-e345e.firebaseapp.com",
  projectId: "rejestracja-czasu-pracy-e345e",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let loginToNameMap = {};
let aktualneDane = [];

firebase.auth().onAuthStateChanged(async user => {
  if (!user) {
    alert("Musisz być zalogowany.");
    location.href = "login.html";
  } else {
    await zaladujUzytkownikow();
    await wczytaj();
  }
});

async function zaladujUzytkownikow() {
  const snapshot = await db.collection("uzytkownicy").get();
  loginToNameMap = {};
  snapshot.forEach(doc => {
    const d = doc.data();
    loginToNameMap[doc.id] = `${d.imie} ${d.nazwisko}`;
  });
}

function obliczGodziny(start, end) {
  if (!start || !end) return "0.00";
  const s = start.toLowerCase();
  const e = end.toLowerCase();
  if (s === "urlop" || e === "urlop") return "urlop";
  if (!/^\d{2}:\d{2}$/.test(start) || !/^\d{2}:\d{2}$/.test(end)) return "0.00";
  const [sh, sm] = start.split(":");
  const [eh, em] = end.split(":");
  const total = (parseInt(eh)*60 + parseInt(em)) - (parseInt(sh)*60 + parseInt(sm));
  return total > 0 ? (total/60).toFixed(2) : "0.00";
}

async function wczytaj() {
  const snapshot = await db.collection("godziny").get();
  const wszystkie = snapshot.docs.map(doc => {
    const d = doc.data();
    return {
      id: doc.id,
      login: d.login || "",
      data: d.data || "",
      start: d.start || "",
      end: d.end || "",
      godziny: d.godziny || obliczGodziny(d.start, d.end),
    };
  });

  const unikalneLoginy = [...new Set(wszystkie.map(d => d.login))];
  const filterUser = document.getElementById("filterUser");

  if (filterUser.options.length <= 1) {
    filterUser.innerHTML = '<option value="">Wszyscy</option>' + 
      unikalneLoginy.map(email => {
        const name = loginToNameMap[email] || email;
        return `<option value="${email}">${name}</option>`;
      }).join('');
  }

  const miesiace = [...new Set(wszystkie.map(d => d.data?.slice(0,7)).filter(Boolean))];
  const filterMonth = document.getElementById("filterMonth");

  if (filterMonth.options.length <= 1) {
    filterMonth.innerHTML = '<option value="">Wszystkie</option>' + 
      miesiace.map(m => `<option value="${m}">${m}</option>`).join('');
  }

  aktualneDane = wszystkie.filter(d =>
    (!filterUser.value || d.login === filterUser.value) &&
    (!filterMonth.value || d.data?.startsWith(filterMonth.value))
  ).sort((a, b) => new Date(b.data) - new Date(a.data));

  const tbody = document.querySelector("#tabela-pracownikow tbody");
  tbody.innerHTML = "";

  aktualneDane.forEach(d => {
    const tr = document.createElement("tr");
    const name = loginToNameMap[d.login] || d.login;
    tr.innerHTML = `
      <td>${name}</td>
      <td>${d.data}</td>
      <td contenteditable onblur="zapiszZmiane('${d.id}', 'start', this.innerText)">${d.start}</td>
      <td contenteditable onblur="zapiszZmiane('${d.id}', 'end', this.innerText)">${d.end}</td>
      <td>${d.godziny}</td>
      <td><button onclick="usunRekord('${d.id}')">Usuń</button></td>
    `;
    tbody.appendChild(tr);
  });

  const suma = aktualneDane
    .filter(r => r.godziny !== "urlop")
    .reduce((acc, r) => acc + parseFloat(r.godziny || 0), 0)
    .toFixed(2);

  document.querySelector("#tabela-pracownikow tfoot").innerHTML = `
    <tr><td colspan="4"><strong>Razem</strong></td><td>${suma}</td><td></td></tr>
  `;
}

async function zapiszZmiane(id, pole, wartosc) {
  wartosc = wartosc.trim().toLowerCase() === "urlop" ? "urlop" : wartosc;
  if (wartosc !== "urlop" && (pole === "start" || pole === "end") && !/^\d{2}:\d{2}$/.test(wartosc)) {
    alert("Błędny format godziny (HH:MM) lub wpisz 'urlop'");
    wczytaj(); return;
  }
  const ref = db.collection("godziny").doc(id);
  const snap = await ref.get();
  if (!snap.exists) return;
  const dane = snap.data();
  dane[pole] = wartosc;
  dane.godziny = obliczGodziny(dane.start, dane.end);
  await ref.set(dane);
  wczytaj();
}

async function usunRekord(id) {
  if (confirm("Usunąć wpis?")) {
    await db.collection("godziny").doc(id).delete();
    wczytaj();
  }
}

document.getElementById("exportBtn").addEventListener("click", () => {
  const wb = XLSX.utils.book_new();

  const daneDoEksportu = aktualneDane.map(row => ({
    Pracownik: loginToNameMap[row.login] || row.login,
    Data: row.data,
    Start: row.start,
    Koniec: row.end,
    Godziny: row.godziny
  }));

  const ws1 = XLSX.utils.json_to_sheet(daneDoEksportu);
  XLSX.utils.book_append_sheet(wb, ws1, "Godziny");

  const raport = aktualneDane.map(row => {
    const isUrlop = row.godziny === "urlop" || row.start === "urlop" || row.end === "urlop";
    return {
      "Kod pracownika": row.login.split("@")[0],
      "Data": row.data,
      "Rodzaj czasu": isUrlop ? "URLOP" : "PRACA",
      "Od godziny": isUrlop ? "" : row.start,
      "Do godziny": isUrlop ? "" : row.end,
      "Liczba godzin": isUrlop ? "" : row.godziny,
      "Opis": isUrlop ? "Urlop" : "Ewidencja RCP"
    };
  });

  const ws2 = XLSX.utils.json_to_sheet(raport);
  XLSX.utils.book_append_sheet(wb, ws2, "Raport enova");

  XLSX.writeFile(wb, "raport_miesieczny.xlsx");
});

document.getElementById("filterUser").addEventListener("change", wczytaj);
document.getElementById("filterMonth").addEventListener("change", wczytaj);
window.zapiszZmiane = zapiszZmiane;
window.usunRekord = usunRekord;
</script>
</body>
</html>
