<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Panel RCP</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f6f8fa; color: #333; }
    h1 { text-align: center; color: #1e3c72; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
    th { background: #f1f4f9; }
    button { margin: 5px; padding: 6px 10px; background: #1e90ff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #167ac6; }
    .status { font-weight: bold; }
  </style>
</head>
<body>
<h1>Panel RCP</h1>
<table id="tabela-pracownikow">
  <thead>
    <tr><th>Login</th><th>Data</th><th>Start</th><th>Koniec</th><th>Godziny</th><th>Status</th><th>Akcje</th></tr>
  </thead>
  <tbody></tbody>
</table>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBctpY5tMVCISGsUsw_PwNUSQPnUlW2nPc",
    authDomain: "rejestracja-czasu-pracy-e345e.firebaseapp.com",
    projectId: "rejestracja-czasu-pracy-e345e",
    storageBucket: "rejestracja-czasu-pracy-e345e.appspot.com",
    messagingSenderId: "198373663295",
    appId: "1:198373663295:web:a2a07384d8814101254e8a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  firebase.auth().onAuthStateChanged(user => {
    if (!user) window.location.href = "login.html";
    else wczytaj();
  });

  const tabelaBody = document.querySelector("#tabela-pracownikow tbody");

  function obliczGodziny(start, end) {
    if (!/^\d{2}:\d{2}$/.test(start) || !/^\d{2}:\d{2}$/.test(end)) return "0.00";
    const [sh, sm] = start.split(":"), [eh, em] = end.split(":");
    const min = (eh * 60 + parseInt(em)) - (sh * 60 + parseInt(sm));
    return min > 0 ? (min / 60).toFixed(2) : "0.00";
  }

  async function wczytaj() {
    const snapshot = await db.collection("godziny").get();
    tabelaBody.innerHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      const id = doc.id;
      const godziny = d.godziny || obliczGodziny(d.start, d.end);
      const status = d.statusNadgodzin || "oczekujące";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.login}</td>
        <td>${d.data}</td>
        <td contenteditable onblur="zapiszZmiane('${id}','start',this.innerText)">${d.start}</td>
        <td contenteditable onblur="zapiszZmiane('${id}','end',this.innerText)">${d.end}</td>
        <td>${godziny}</td>
        <td class="status">${status}</td>
        <td>
          <button onclick="zmienStatus('${id}', 'zaakceptowane')">Akceptuj</button>
          <button onclick="zmienStatus('${id}', 'odrzucone')">Odrzuć</button>
        </td>`;
      tabelaBody.appendChild(tr);
    });
  }

  async function zapiszZmiane(id, pole, wartosc) {
    if ((pole === "start" || pole === "end") && !/^\d{2}:\d{2}$/.test(wartosc)) return alert("Błędny format HH:MM");
    const ref = db.collection("godziny").doc(id);
    const snap = await ref.get();
    if (!snap.exists) return;
    const dane = snap.data();
    dane[pole] = wartosc;
    if (dane.start && dane.end) dane.godziny = obliczGodziny(dane.start, dane.end);
    if (!dane.statusNadgodzin) dane.statusNadgodzin = "oczekujące";
    await ref.set(dane);
    wczytaj();
  }

  async function zmienStatus(id, status) {
    await db.collection("godziny").doc(id).update({ statusNadgodzin: status });
    wczytaj();
  }
</script>
</body>
</html>
