<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Panel Kierownika</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
   <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: linear-gradient(to right, #2b5876, #4e4376);
      color: #fff;
    }
    h1 {
      text-align: center;
      font-size: 32px;
      margin-bottom: 30px;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    input, select, button {
      margin: 5px;
      padding: 12px 15px;
      font-size: 14px;
      border-radius: 8px;
      border: 2px solid #fff;
      outline: none;
      transition: all 0.3s ease;
    }
    input:focus, select:focus, button:focus {
      border-color: #ff7c5d;
      box-shadow: 0 0 10px rgba(255, 124, 93, 0.8);
    }
    button {
      background-color: #ff7c5d;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease-in-out;
    }
    button:hover {
      background-color: #ff5a3e;
      transform: scale(1.05);
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 30px;
      background-color: #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th {
      background-color: #ff7c5d;
      padding: 12px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 14px;
      color: #fff;
      text-align: center;
    }
    td {
      padding: 12px;
      border-top: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
      color: #333;
    }
    td[contenteditable] {
      background-color: #f0f0f0;
      cursor: pointer;
    }
    .status-green {
      background-color: #28a745;
      color: white;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .status-red {
      background-color: #dc3545;
      color: white;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .status-yellow {
      background-color: #ffc107;
      color: black;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .container {
      margin: 0 auto;
      max-width: 1200px;
    }
  </style>
</head>
<body>
  <h1>Panel Kierownika</h1>

  <div>
    <label>Pracownik:</label>
    <select id="filterLogin">
      <option value="">-- Wszyscy --</option>
    </select>

    <label>Data:</label>
    <input type="date" id="filterDate">

    <button onclick="filtruj()">Filtruj</button>
    <button id="exportBtn">Eksportuj do Excela</button>
    <button onclick="drukuj()">Drukuj</button> <!-- Przycisk do drukowania -->
  </div>

  <table>
    <thead>
      <tr>
        <th>Pracownik</th>
        <th>Data</th>
        <th>Start</th>
        <th>Koniec</th>
        <th>Godziny</th>
        <th>Status</th>
        <th>Akcja</th>
        <th>Usu≈Ñ</th>
      </tr>
    </thead>
    <tbody id="tabela"></tbody>
    <tfoot id="stopka"></tfoot>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBctpY5tMVCISGsUsw_PwNUSQPnUlW2nPc",
      authDomain: "rejestracja-czasu-pracy-e345e.firebaseapp.com",
      projectId: "rejestracja-czasu-pracy-e345e",
      storageBucket: "rejestracja-czasu-pracy-e345e.appspot.com",
      messagingSenderId: "198373663295",
      appId: "1:198373663295:web:a2a07384d8814101254e8a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tabela = document.getElementById("tabela");
    const stopka = document.getElementById("stopka");
    const exportBtn = document.getElementById("exportBtn");

    let daneWidoczne = [];
    let mapaUzytkownikow = {}; // email => "Imiƒô Nazwisko"

    const login10h = [
      "a.krzon@naszprad.com", "e.labaz@naszprad.com",
      "n.gmitruk@naszprad.com", "p.haczkiewicz@naszprad.com"
    ];

    function obliczGodziny(start, end) {
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      const diff = ((eh * 60 + em) - (sh * 60 + sm)) / 60;
      return diff > 0 ? diff.toFixed(2) : "0.00";
    }

    function getNorma(login) {
      return login10h.includes(login.toLowerCase()) ? 10 : 8;
    }

    function formatujGodzinyDziesietne(decimalHours) {
      const godziny = Math.floor(decimalHours);
      const minuty = Math.round((decimalHours - godziny) * 60);
      return `${godziny}h ${minuty}min`;
    }

    firebase.auth().onAuthStateChanged(async user => {
      if (!user) return location.href = "index.html";

      const doc = await db.collection("users").doc(user.email).get();
      const data = doc.data();
      if (!data || !data.rola || !data.podwladni) return location.href = "index.html";

      const podwladni = data.podwladni;
      const snapUzytkownicy = await db.collection("uzytkownicy").get();
      snapUzytkownicy.forEach(d => {
        const u = d.data();
        if (u.imie && u.nazwisko) {
          mapaUzytkownikow[d.id] = `${u.imie} ${u.nazwisko}`;
        }
      });

      const select = document.getElementById("filterLogin");
      podwladni.forEach(email => {
        const option = document.createElement("option");
        option.value = email;
        option.textContent = mapaUzytkownikow[email] || email;
        select.appendChild(option);
      });

      const snap = await db.collection("godziny").get();
      const daneGodziny = snap.docs
        .map(doc => ({ id: doc.id, ...doc.data(), typ: "godziny" }));

      const snapUrlopy = await db.collection("urlopy").get();
      const daneUrlopy = snapUrlopy.docs
        .map(doc => ({ id: doc.id, ...doc.data(), typ: "urlop", godziny: "urlop" }));

      daneWidoczne = [...daneGodziny, ...daneUrlopy].filter(r => podwladni.includes(r.login));

      renderujTabele(daneWidoczne);
    });

    function renderujTabele(dane) {
  tabela.innerHTML = "";
  stopka.innerHTML = "";
  
  // Sortowanie po dacie: najpierw miesiƒÖc, potem dzie≈Ñ
  dane.sort((a, b) => {
    const dataA = new Date(a.data);
    const dataB = new Date(b.data);
    
    // Por√≥wnanie po miesiƒÖcu
    if (dataA.getMonth() !== dataB.getMonth()) {
      return dataA.getMonth() - dataB.getMonth();
    }

    // Je≈õli miesiƒÖce sƒÖ takie same, por√≥wnanie po dniu
    return dataA.getDate() - dataB.getDate();
  });

  dane.forEach(row => {
    const norma = getNorma(row.login);
    const godz = parseFloat(row.godziny) || 0;
    const status = row.status || (godz > norma ? "oczekuje" : "zaakceptowane");
    const kolor = status === "zaakceptowane" ? "status-green" :
                  status === "odrzucone" ? "status-red" : "status-yellow";

    const pokazGodziny = row.godziny === "urlop" ? "urlop" : formatujGodzinyDziesietne(godz);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${mapaUzytkownikow[row.login] || row.login}</td>
      <td>${row.data}</td>
      <td contenteditable onblur="zapisz('${row.id}', 'start', this.innerText)">${row.start === "undefined" || row.start === undefined ? "urlop" : row.start}</td>
      <td contenteditable onblur="zapisz('${row.id}', 'end', this.innerText)">${row.end === "undefined" || row.end === undefined ? "urlop" : row.end}</td>
      <td>${pokazGodziny}</td>
      <td class="${kolor}">${status}</td>
      <td>
        ${godz > norma && status !== "zaakceptowane" ? ` 
          <button onclick="zatwierdz('${row.id}')">Akceptuj</button>
          <button onclick="odrzuc('${row.id}')">Odrzuƒá</button>
        ` : ""}
      </td>
      <td><button onclick="usun('${row.id}')">üóëÔ∏è</button></td>
    `;
    tabela.appendChild(tr);
  });

  const suma = dane.reduce((sum, r) => {
    let godz = parseFloat(r.godziny) || 0;
    if (r.status === "odrzucone" && godz > getNorma(r.login)) {
      godz = getNorma(r.login);
    }
    return sum + godz;
  }, 0).toFixed(2);

  stopka.innerHTML = `
    <tr>
      <td colspan="4"><strong>Razem</strong></td>
      <td><strong>${formatujGodzinyDziesietne(parseFloat(suma))}</strong></td>
      <td colspan="3"></td>
    </tr>
  `;
}

    async function zapisz(id, pole, wartosc) {
      if (!/^\d{2}:\d{2}$/.test(wartosc)) {
        alert("Nieprawid≈Çowy format godziny (HH:MM)");
        return location.reload();
      }
      const ref = db.collection("godziny").doc(id);
      const doc = await ref.get();
      const data = doc.data();
      data[pole] = wartosc;
      if (data.start && data.end) {
        data.godziny = obliczGodziny(data.start, data.end);
      }
      await ref.set(data);
      location.reload();
    }

    async function zatwierdz(id) {
      await db.collection("godziny").doc(id).update({ status: "zaakceptowane" });
      location.reload();
    }

    async function odrzuc(id) {
      const doc = await db.collection("godziny").doc(id).get();
      const data = doc.data();
      const norma = getNorma(data.login);
      data.status = "odrzucone";
      if (parseFloat(data.godziny) > norma) {
        data.godziny = norma.toFixed(2);
      }
      await db.collection("godziny").doc(id).set(data);
      location.reload();
    }

    async function usun(id) {
  console.log(`Sprawdzanie dokumentu o ID: ${id}`);

  // Pr√≥bujemy znale≈∫ƒá dokument w kolekcji "godziny"
  const refGodziny = db.collection("godziny").doc(id);
  const docGodziny = await refGodziny.get();

  if (docGodziny.exists) {
    const dataGodziny = docGodziny.data();
    console.log("Dokument w kolekcji godziny:", dataGodziny); // Logowanie danych z kolekcji "godziny"

    // Je≈õli dane zawierajƒÖ "urlop" w jednym z p√≥l, mo≈ºemy usunƒÖƒá ten wiersz
    if (dataGodziny.start === "urlop" || dataGodziny.end === "urlop" || dataGodziny.godziny === "urlop") {
      if (confirm("Czy na pewno chcesz usunƒÖƒá ten wiersz z urlopem?")) {
        await db.collection("godziny").doc(id).delete();
        location.reload();
      }
    } else {
      if (confirm("Czy na pewno chcesz usunƒÖƒá ten wiersz?")) {
        await db.collection("godziny").doc(id).delete();
        location.reload();
      }
    }
  } 
  // Je≈õli dokument nie istnieje w kolekcji "godziny", sprawdzamy kolekcjƒô "urlopy"
  else {
    const refUrlopy = db.collection("urlopy").doc(id);
    const docUrlopy = await refUrlopy.get();
    if (docUrlopy.exists) {
      const dataUrlopy = docUrlopy.data();
      console.log("Dokument w kolekcji urlopy:", dataUrlopy); // Logowanie danych z kolekcji "urlopy"

      // Sprawdzamy, czy dokument ma pola "zakresOd" i "zakresDo"
      if (dataUrlopy.zakresOd && dataUrlopy.zakresDo) {
        if (confirm("Czy na pewno chcesz usunƒÖƒá ten urlop?")) {
          await db.collection("urlopy").doc(id).delete();
          location.reload();
        }
      } else {
        alert("Nie znaleziono danych urlopu do usuniƒôcia.");
      }
    } else {
      console.log("Nie znaleziono dokumentu w ≈ºadnej z kolekcji");
      alert("Nie znaleziono danych do usuniƒôcia.");
    }
  }
}

    function filtruj() {
      const log = document.getElementById("filterLogin").value;
      const dat = document.getElementById("filterDate").value;
      const wynik = daneWidoczne.filter(r =>
        (log === "" || r.login === log) &&
        (dat === "" || r.data === dat)
      );
      renderujTabele(wynik);
    }

    exportBtn.addEventListener("click", () => {
      const wb = XLSX.utils.book_new();
      const daneDoXLSX = daneWidoczne.map(r => {
        const norma = getNorma(r.login);
        let godz = parseFloat(r.godziny) || 0;
        if (r.status === "odrzucone" && godz > norma) {
          godz = norma;
        }
        return {
          Pracownik: mapaUzytkownikow[r.login] || r.login,
          Data: r.data,
          Start: r.start,
          Koniec: r.end,
          Godziny: formatujGodzinyDziesietne(godz),
          Status: r.status || "zaakceptowane"
        };
      });
      const ws = XLSX.utils.json_to_sheet(daneDoXLSX);
      XLSX.utils.book_append_sheet(wb, ws, "Godziny");
      XLSX.writeFile(wb, "godziny_kierownik.xlsx");
    });

    function drukuj() {
      const nowaStrona = window.open('', '', 'height=600,width=800');
      const tabela = document.querySelector("table");
      const tabelaDoDruku = tabela.cloneNode(true); // Kopiujemy tabelƒô do wydruku

      // Usuwamy kolumny "Status", "Akcja" i "Usu≈Ñ"
      const th = tabelaDoDruku.querySelectorAll("th");
      const td = tabelaDoDruku.querySelectorAll("td");

      // Usuwamy odpowiednie kolumny w tabeli
      for (let i = 0; i < th.length; i++) {
        if (th[i].textContent === "Status" || th[i].textContent === "Akcja" || th[i].textContent === "Usu≈Ñ") {
          th[i].remove();
          let index = i;
          td.forEach(t => {
            if (t.cellIndex === index) t.remove();
          });
        }
      }

      const tre≈õƒá = `
        <html>
        <head>
          <title>Lista obecno≈õci</title>
          <style>
            body {
              font-family: 'Segoe UI', sans-serif;
              text-align: center;
              margin: 0;
              padding: 20px;
            }
            table {
              width: 100%; border-collapse: collapse; margin-top: 20px;
            }
            th, td {
              padding: 10px; border: 1px solid #ccc;
              text-align: center;
            }
            th {
              background-color: #f5f7fa;
              font-weight: bold;
            }
            td {
              font-size: 14px;
            }
            .footer {
              margin-top: 30px;
              font-size: 16px;
            }
            h1 {
              font-size: 24px;
              margin-bottom: 20px;
            }
          </style>
        </head>
        <body>
          <h1>Lista obecno≈õci za ..........</h1>
          ${tabelaDoDruku.outerHTML}
          <div class="footer">Podpis: __________________</div>
        </body>
        </html>
      `;
      nowaStrona.document.write(tre≈õƒá);
      nowaStrona.document.close();
      nowaStrona.print();
    }
  </script>
</body>
</html>
